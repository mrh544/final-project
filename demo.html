<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/async@3.2.0/dist/async.min.js"></script>
  <script type="text/javascript">
  /*
  * Helper functions
  */
  function parseDOM(data)
  {
    const parser = new DOMParser();
    let dom = parser.parseFromString(data, "text/html");
    return $(dom.body);
  }

  function parseXML(data)
  {
    const xml = new XMLSerializer().serializeToString(data);
    let xmlDoc = $.parseXML(xml);
    return $(xmlDoc);
  }

  /*
  * Form 13F is a filing that all institutional investors who manage over $100 million in assets must submit to the SEC
  * on a quarterly basis.
  */
  function getFormThirteenF(fundID, callback)
  {
    $.get('https://www.sec.gov/cgi-bin/browse-edgar?CIK=' + fundID + '&count=10&type=13F-HR&output=atom',  function(data) {
      let xml = parseXML(data);
      let entries = xml.find('entry');

      let fundURL;
      // only retrieve the latest entry
      let entryURL = $(entries[0]).find('link')[0].attributes[0].nodeValue;
      let accessionNumber = $(entries[0]).find('content')[0].childNodes[1].firstChild.nodeValue;

      fundURL = entryURL.substring(0, entryURL.lastIndexOf("/") + 1) + accessionNumber + '.txt';

      callback(null, fundURL);
    });
  }

  /*
  * An infotable is a list of all the investor's holdings on the 13F report
  */
  function getInfoTable(fundURL, callback)
  {
    fetch(fundURL).then(data => data.text()).then(data => {
      let dom = parseDOM(data);
      let documents = dom.find('document');

      let infoTableXML;
      for(var i = 0; i < documents.length; i++)
      {
        let document_type = $(documents[i]).find('type')[0].firstChild.nodeValue;

        if(document_type.includes("INFORMATION TABLE"))
          infoTableXML = $(documents[i]).find('xml')[0];
      }
      callback(null, infoTableXML);
    });
  }


  function getHoldings(infoTableXML, callback)
  {
    // escape any xml namespaces when scraping data
    infoTableXML.innerHTML = infoTableXML.innerHTML.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g, "<$1$3>")

    let xml = parseXML(infoTableXML);
    let info = xml.find('infotable');
    let cusip = xml.find('cusip');
    let name = xml.find('nameofissuer');
    let title = xml.find('titleofclass');
    let value = xml.find('value');
    let shares = xml.find('sshprnamt');

    let holdings = [];
    let num = 0;
    for(let i = 0; i < info.length; i++) {
      // exclude warrants (*W) from holdings list
      if(title[i].textContent !== '*W')
      {
        holdings[num] = {
          'cusip' : cusip[i].textContent,
          'shares' : parseInt(shares[i].textContent),
          'purchasePrice' : parseFloat(getPurchasePrice(value[i].textContent, shares[i].textContent))
        }
        num++;
      }
    }

    console.log(holdings);

    callback(null, holdings);
  }

  function addTickers(holdings, callback)
  {
    let count = 0;

    console.log(holdings);

    holdings.forEach(function(obj)
    {
      fetch('https://api.vanguard.com/rs/sae/search/securities.json?q=' + obj.cusip).then(data => data.json()).then(data => {
        // add a period between uppercase and lowercase letters so that BRKb becomes BRK.b (this distinction is needed for IEX API)
        let symbol = data.results[0].symbol;
        symbol = symbol.replace(/([A-Z])([a-z])/g, '$1.$2');

        // add ticker key/value pair to object
        holdings.find((e, i) => {
            if (e.cusip === obj.cusip) {
                holdings[i].ticker = symbol;
            }
        });
      }).then(function() {
        count++;
        if(count === holdings.length) {
          callback(null, holdings);
        }
      });
    });
  }

  function getStockInfo(holdings, callback)
  {
    let tickers = [];
    holdings.forEach(function(obj) {
      tickers.push(obj.ticker);
    });

    const apiToken = 'pk_f5c07fe30e3f4fcea2b684c4b6974d55';

    fetch('https://cloud.iexapis.com/v1/tops/last?symbols=' + tickers + '&token=' + apiToken).then(data => data.json()).then(data => {
      for(let i = 0; i < holdings.length; i++)
        holdings[i].currentPrice = data[i].price;

      callback(null, holdings);
    });
  }

  function getPurchasePrice(purchaseValue, numShares)
  {
    let purchasePrice = ((purchaseValue * 1000) / numShares).toFixed(2);

    return purchasePrice;
  }

  function getCurrentValue(holdings)
  {
    let currentValue = 0;
    holdings.forEach(function(obj) {
      currentValue += (obj.currentPrice * obj.shares);
    });
    return currentValue;
  }

  function getPurchaseValue(holdings)
  {
    let purchaseValue = 0;
    holdings.forEach(function(obj) {
      purchaseValue += (obj.purchasePrice * obj.shares);
    });
    return purchaseValue;
  }

  function getROI(purchaseValue, currentValue)
  {
    let roi = ((currentValue - purchaseValue) / purchaseValue) * 100;
    return parseFloat((roi).toFixed(2));
  }

  function rankInvestors(investors)
  {
    var array = [];

    investors.forEach(function(investor) {
      array.push(investor);
    });

    array.sort(function(a, b){
        return b.roi - a.roi;
    });

    var rank = 1;
    for (var i = 0; i < array.length; i++) {
      // increase rank only if current roi is less than previous
      if (i > 0 && array[i].roi < array[i - 1].roi) {
        rank++;
      }
      array[i].rank = rank;
    }

    return array;
  }

  function getFund(callback)
  {
    const funds = ['0001336528', '0000936753']; // ['0001336528', '0000936753', '0001067983'];

    funds.forEach(function(fundID)
    {
      callback(null, fundID);
    });
  }

  function getFileContents(fileID, callback)
  {
    fetch('./data/' + fileID + '.json').then(data => data.json()).then(data => {
      callback(null, data);
    });
  }

  // KNOWN ISSUES: Warrants (*W), example: https://www.sec.gov/Archives/edgar/data/921669/000156761920019587/xslForm13F_X01/form13fInfoTable.xml
  // ^ possible fix is excluding from returns


  // using async.js's forEach() and waterfall() to run async functions in sequence
  function retrieveData(funds)
  {
    let investors = [];

    async.forEach(funds, function(fundID, next)
    {
      async.waterfall([
        function(callback) { callback(null, fundID); },
        getFormThirteenF,
        getInfoTable,
        getHoldings,
        addTickers,
      ], function (error, holdings) {
        console.log(JSON.stringify(holdings));

        next(error, holdings);
      });
    }, function (error) {
    });

    // async.forEach(funds, function(fundID, next)
    // {
    //   async.waterfall([
    //     function(callback) { callback(null, fundID); },
    //     getFormThirteenF,
    //     getInfoTable,
    //     getHoldings,
    //     addTickers,
    //     // all previous functions can be run once and data is stored
    //     getStockInfo
    //   ], function (error, holdings) {
    //     // one fund done
    //     let purchaseValue = getPurchaseValue(holdings);
    //     let currentValue = getCurrentValue(holdings);
    //
    //     let obj = {
    //       'fund' : fundID,
    //       'roi' : getROI(purchaseValue, currentValue)
    //     }
    //     investors.push(obj);
    //     next(error, holdings);
    //   });
    // }, function (error) {
    //   // all funds done
    //   console.log(rankInvestors(investors));
    // });
  }

  function initialize()
  {
    const funds = ['0000921669'];
    // const funds = ['0001771524', '0000921669', '0001166559']; // ['0001336528', '0000936753', '0001067983'];

    // addCallback, once data is retrieved, display it on website
    retrieveData(funds);
  }
  initialize();

  // https://whalewisdom.com/whaleindex

  /* function postToExcel()
  {
    var cusips = ['1', '100', '1000', '10'];
    var tickers = ['A', 'B', 'C', 'D'];
    window.open('https://script.google.com/macros/s/AKfycbysOrrIRKKS6FDbZ0JDxjFxRHZT56JixR5lt54hrDIB/exec?cusips=' + cusips + '&tickers=' + tickers);
  }

  appendToSheet(); */

/*
  function getFromExcel(cusips, callback)
  {
    const sheetID = '1pQgH9pdeEzhuIr2jgsUiNzeze_-9PUof7x7zpWB40tA';
    fetch('https://spreadsheets.google.com/feeds/cells/' + sheetID + '/1/public/full?alt=json').then(data => data.json()).then(data => {
      let entries = data.feed.entry;
      console.log(entries);

      let obj = {};
      for(let i = 0; i < entries.length; i += 3)
      {
        let cusip = entries[i].content.$t;
        let ticker = entries[i + 1].content.$t;
        let price  = entries[i + 2].content.$t;

        if(cusips.includes(cusip))
          obj[cusip] = {
             "ticker" : ticker,
             "price" : price
          }
      }

      callback(obj);
    });
  } */
  </script>
  </body>
</html>
